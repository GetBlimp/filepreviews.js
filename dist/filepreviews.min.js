/* filepreviews 1.0.7 */
!function(){function a(){this._object=!window.XMLHttpRequest||k?new window.ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest.isNormalizedObject?new h:new window.XMLHttpRequest,this._listeners=[]}function b(){return new a}function c(a){if(a._object.send(a._data),i&&!a._async)for(a.readyState=b.OPENED,f(a);a.readyState<b.DONE;)if(a.readyState++,d(a),a._aborted)return}function d(a){b.onreadystatechange&&b.onreadystatechange.apply(a),a.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:(new Date).getTime()})}function e(a){var b=a.responseXML,c=a.responseText;return j&&c&&b&&!b.documentElement&&a.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(b=new window.ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.validateOnParse=!1,b.loadXML(c)),b&&(j&&0!=b.parseError||!b.documentElement||b.documentElement&&"parsererror"==b.documentElement.tagName)?null:b}function f(a){try{a.responseText=a._object.responseText}catch(b){}try{a.responseXML=e(a._object)}catch(b){}try{a.status=a._object.status}catch(b){}try{a.statusText=a._object.statusText}catch(b){}}function g(a){a._object.onreadystatechange=new window.Function}var h=window.XMLHttpRequest,i=!!window.controllers,j=!!window.document.namespaces,k=j&&window.navigator.userAgent.match(/MSIE 7.0/);b.prototype=a.prototype,i&&h.wrapped&&(b.wrapped=h.wrapped),b.isNormalizedObject=!0,b.UNSENT=0,b.OPENED=1,b.HEADERS_RECEIVED=2,b.LOADING=3,b.DONE=4,b.prototype.UNSENT=b.UNSENT,b.prototype.OPENED=b.OPENED,b.prototype.HEADERS_RECEIVED=b.HEADERS_RECEIVED,b.prototype.LOADING=b.LOADING,b.prototype.DONE=b.DONE,b.prototype.readyState=b.UNSENT,b.prototype.responseText="",b.prototype.responseXML=null,b.prototype.status=0,b.prototype.statusText="",b.prototype.priority="NORMAL",b.prototype.onreadystatechange=null,b.onreadystatechange=null,b.onopen=null,b.onsend=null,b.onabort=null,b.prototype.open=function(a,c,e,h,k){var l=a.toLowerCase();if("connect"==l||"trace"==l||"track"==l)throw new Error(18);delete this._headers,arguments.length<3&&(e=!0),this._async=e;var m=this,n=this.readyState,o=null;j&&e&&(o=function(){n!=b.DONE&&(g(m),m.abort())},window.attachEvent("onunload",o)),b.onopen&&b.onopen.apply(this,arguments),arguments.length>4?this._object.open(a,c,e,h,k):arguments.length>3?this._object.open(a,c,e,h):this._object.open(a,c,e),this.readyState=b.OPENED,d(this),this._object.onreadystatechange=function(){return!i||e?(m.readyState=m._object.readyState,f(m),m._aborted?void(m.readyState=b.UNSENT):void(m.readyState==b.DONE&&(delete m._data,g(m),j&&e&&window.detachEvent("onunload",o),n!=m.readyState&&d(m),n=m.readyState))):void 0}},b.prototype.send=function(a){b.onsend&&b.onsend.apply(this,arguments),arguments.length||(a=null),a&&a.nodeType&&(a=window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):a.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=a,c(this)},b.prototype.abort=function(){b.onabort&&b.onabort.apply(this,arguments),this.readyState>b.UNSENT&&(this._aborted=!0),this._object.abort(),g(this),this.readyState=b.UNSENT,delete this._data},b.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},b.prototype.getResponseHeader=function(a){return this._object.getResponseHeader(a)},b.prototype.setRequestHeader=function(a,b){return this._headers||(this._headers={}),this._headers[a]=b,this._object.setRequestHeader(a,b)},b.prototype.addEventListener=function(a,b,c){for(var d,e=0;d=this._listeners[e];e++)if(d[0]==a&&d[1]==b&&d[2]==c)return;this._listeners.push([a,b,c])},b.prototype.removeEventListener=function(a,b,c){for(var d,e=0;(d=this._listeners[e])&&(d[0]!=a||d[1]!=b||d[2]!=c);e++);d&&this._listeners.splice(e,1)},b.prototype.dispatchEvent=function(a){var b={type:a.type,target:this,currentTarget:this,eventPhase:2,bubbles:a.bubbles,cancelable:a.cancelable,timeStamp:a.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};"readystatechange"==b.type&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[b]);for(var c,d=0;c=this._listeners[d];d++)c[0]!=b.type||c[2]||(c[1].handleEvent||c[1]).apply(this,[b])},b.prototype.toString=function(){return"[object XMLHttpRequest]"},b.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(a,b){b||(b=[]),a.__func=this,a.__func(b[0],b[1],b[2],b[3],b[4]),delete a.__func}),window.XMLHttpRequest=b}(),function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.ajax=b()}(this,function(){function a(a,b){b=b||{},b.method=b.method||"GET",b.headers=b.headers||{},b.success=b.success||function(){},b.error=b.error||function(){},b.async="undefined"==typeof b.async?!0:b.async;var c=new XMLHttpRequest;c.open(b.method,a);for(var d in b.headers)b.headers.hasOwnProperty(d)&&c.setRequestHeader(d,b.headers[d]);return c.send(b.data),c.onreadystatechange=function(){4==this.readyState&&200==this.status?b.success(this.responseText,this):4==this.readyState&&b.error(this.status,this.statusText,this)},c}return a});var CryptoJS=CryptoJS||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;a>e;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;a>e;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;b>d;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;a>d;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(b){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;b>i;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){for(var b=CryptoJS,c=b.lib,d=c.WordArray,e=c.Hasher,c=b.algo,f=[],g=[],h=function(a){return 4294967296*(a-(0|a))|0},i=2,j=0;64>j;){var k;a:{k=i;for(var l=a.sqrt(k),m=2;l>=m;m++)if(!(k%m)){k=!1;break a}k=!0}k&&(8>j&&(f[j]=h(a.pow(i,.5))),g[j]=h(a.pow(i,1/3)),j++),i++}var n=[],c=c.SHA256=e.extend({_doReset:function(){this._hash=new d.init(f.slice(0))},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],e=c[1],f=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=0;64>m;m++){if(16>m)n[m]=0|a[b+m];else{var o=n[m-15],p=n[m-2];n[m]=((o<<25|o>>>7)^(o<<14|o>>>18)^o>>>3)+n[m-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+n[m-16]}o=l+((i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25))+(i&j^~i&k)+g[m]+n[m],p=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&e^d&f^e&f),l=k,k=j,j=i,i=h+o|0,h=f,f=e,e=d,d=o+p|0}c[0]=c[0]+d|0,c[1]=c[1]+e|0,c[2]=c[2]+f|0,c[3]=c[3]+h|0,c[4]=c[4]+i|0,c[5]=c[5]+j|0,c[6]=c[6]+k|0,c[7]=c[7]+l|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;return c[e>>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+14]=a.floor(d/4294967296),c[(e+64>>>9<<4)+15]=d,b.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var a=e.clone.call(this);return a._hash=this._hash.clone(),a}});b.SHA256=e._createHelper(c),b.HmacSHA256=e._createHmacHelper(c)}(Math),function(){"use strict";var a,b="https://blimp-previews.herokuapp.com/?size=1&url=",c="https://s3.amazonaws.com/demo.filepreviews.io/";return a=function(a){a=a||{},this._cache={},this.debug=a.debug||!1,this.resultsUrl=a.resultsUrl||c},a.prototype._log=function(a){return this.debug&&console.log(a),this},a.prototype.hash=function(a){if(!CryptoJS)throw new Error("CryptoJS library not found.");return CryptoJS.SHA256(a).toString()},a.prototype.generate=function(a,b){var c,d=this.hash(a);this._cache[d]?(this._log("Cache hit"),c=this._cache[d],c.isCached=!0,b(null,c)):(this._log("Cache miss"),this._submitJobToAPI(a,function(a,c){a?this._log("Error: "+a):this._cache[d]=c,this._log("Processing done :)"),b(a,c)}.bind(this)))},a.prototype._submitJobToAPI=function(a,b){this._log("API request to: "+this.getAPIRequestURL(a)),ajax(this.getAPIRequestURL(a),{success:function(c,d){this._log("API request success: "+d.status+" "+d.statusText),this._pollForMetadata(a,function(c,d){b(null,{metadata:d,previewURL:this.getPreviewURL(a)})}.bind(this))}.bind(this),error:function(c,d,e){var f="API request error: ";429===c?(f+="Throttling error, try later",this._log(f),b(f)):(this._log("API request success: "+e.status+" "+e.statusText),this._pollForMetadata(a,function(c,d){b(null,{metadata:d,previewURL:this.getPreviewURL(a)})}.bind(this)))}.bind(this)})},a.prototype._pollForMetadata=function(a,b){var c=1,d=1e3,e=function(){this._log("Polling for metadata, tries: "+c),ajax(this.getMetadataURL(a),{success:function(a){this._log("Metadata found"),b(null,JSON.parse(a))}.bind(this),error:function(){d+=1e3*c,c++,this._log("Metadata not found next try in: "+d),setTimeout(e,d)}.bind(this)})}.bind(this);return e()},a.prototype.getAPIRequestURL=function(a){return b+a},a.prototype.getMetadataURL=function(a){return this.resultsUrl+this.hash(a)+"/metadata.json"},a.prototype.getPreviewURL=function(a){return this.resultsUrl+this.hash(a)+"/"+this.getPreviewFilename(this.getFilename(a))+"_original_1.png"},a.prototype.getFilename=function(a){return a.split("/").pop()},a.prototype.getPreviewFilename=function(a){return a.substr(0,a.lastIndexOf("."))||a},"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=a:window.FilePreviews=a,a}();